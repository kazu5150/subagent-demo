# Claude Code サブエージェント学習プロジェクト

このプロジェクトは、Claude Codeの**内部機構であるサブエージェント**の仕組みを理解するためのサンプルです。

## 使い方

### 1. プロジェクトをクローン

```bash
git clone https://github.com/kazu5150/subagent-demo.git
cd subagent-demo
npm install
```

### 2. Claude Codeで開く

```bash
claude
```

またはVS Code/Cursorで開いてClaude Code拡張機能を使用します。

### 3. プロンプトを試す

Claude Codeに以下のようなプロンプトを入力してみてください：

```
Calculatorクラスはどのようなメソッドを持っていますか？
```

```
このプロジェクトにログ機能を追加したいです。計画を立ててください。
```

```
このプロジェクトをビルドしてください。
```

Claude Codeが内部でサブエージェントを使って処理する様子を観察できます。

---

## サブエージェントとは何か

**サブエージェントはユーザーが直接操作するものではありません。**

Claude Codeが複雑なタスクを処理する際に、**内部で自動的に**起動する専門化されたエージェントです。ユーザーは普通に話しかけるだけで、Claude Codeが必要に応じてサブエージェントを使います。

```
ユーザー: 「このプロジェクトのエラーハンドリングはどのように実装されていますか？」
    ↓
Claude Code: （内部でExploreサブエージェントを起動してコードを探索）
    ↓
ユーザー: 回答を受け取る（サブエージェントの存在は意識しない）
```

## サブエージェントを使うメリット

| メリット | 説明 |
|---------|------|
| **コンテキストの分離** | サブエージェントは独立したコンテキストで動作するため、メインの会話が複雑にならない |
| **並列処理** | 複数のサブエージェントを同時に実行し、独立したタスクを効率的に処理 |
| **専門化** | 各サブエージェントは特定のタスク（探索、計画、コマンド実行など）に最適化されている |
| **自律的な実行** | 複数ステップのタスクを、ユーザーとのやり取りなしで自律的に完了 |
| **バックグラウンド実行** | 長時間かかるタスクをバックグラウンドで実行し、完了後に結果を受け取れる |

例えば「テストを実行しながら、ドキュメントも生成して」と依頼すると、Claude Codeは内部で2つのサブエージェントを**並列**で起動し、効率的に処理します。

## サブエージェントの種類

Claude Codeは、タスクの性質に応じて適切なサブエージェントを**自動選択**します。

| タイプ | 内部で使われる場面 |
|--------|-------------------|
| `Explore` | コードベースの探索・理解が必要な質問をした時 |
| `Plan` | 実装計画の設計を依頼した時 |
| `Bash` | ビルドやテストなどコマンド実行が必要な時 |
| `general-purpose` | 複数ステップの複雑なタスクを依頼した時 |

## サブエージェントを使うかどうかの判断

Claude Codeは**常にサブエージェントを使うわけではありません**。タスクの内容や状況に応じて自動判断します。

| 状況 | Claude Codeの判断 |
|------|------------------|
| 簡単な質問、既に読んだファイルについて | **直接回答**（サブエージェント不要） |
| 小さな修正、単一ファイルの編集 | **直接処理**（サブエージェント不要） |
| 大規模なコードベース探索が必要 | **Explore**サブエージェントを起動 |
| 複雑な実装計画が必要 | **Plan**サブエージェントを起動 |
| ビルド・テストなどコマンド実行が必要 | **Bash**サブエージェントを起動 |
| 複数ステップの複雑なタスク | **general-purpose**サブエージェントを起動 |

### 具体例

```
Q: 「エラーハンドリングはどう実装されていますか？」

A: 既にファイルを読んでいる場合 → 直接回答
   初めてのセッションで大きなコードベースの場合 → Exploreサブエージェントで探索
```

つまり、**同じ質問でも状況によってサブエージェントが使われるかどうかは変わります**。

## サブエージェントの内部動作

1. ユーザーがClaude Codeにプロンプトを入力
2. **Claude Codeがタスクの性質を分析**
3. **サブエージェントが必要か判断**（不要なら直接処理）
4. 必要な場合、適切なサブエージェントタイプを自動選択
5. 内部で`Task`ツールを使いサブエージェントを起動
6. サブエージェントが自律的にタスクを実行
7. 結果がメインのClaude Codeに返され、ユーザーに回答

## 学習のポイント

1. **ユーザーは普通に話しかけるだけ** - サブエージェントを意識する必要はない
2. **Claude Codeが自動判断** - タスクに応じて最適なサブエージェントを選択
3. **並列処理も自動** - 独立したタスクは内部で並列実行される
4. **結果の統合** - サブエージェントの結果は自動的に統合されて返される

---

## プロジェクト構成

```
subagent-demo/
├── src/
│   ├── calculator.ts     # 計算機クラス（履歴機能付き）
│   ├── user-service.ts   # ユーザーCRUDサービス（インメモリ）
│   └── api-handler.ts    # APIハンドラー（エラーハンドリング）
├── package.json
├── tsconfig.json
├── CLAUDE.md
└── README.md
```

### 各モジュールの詳細

| モジュール | クラス | 主な機能 |
|-----------|--------|----------|
| `calculator.ts` | `Calculator` | 四則演算、計算履歴の保存・取得・クリア |
| `user-service.ts` | `UserService` | ユーザーの作成・取得・更新・削除・メール検索 |
| `api-handler.ts` | `ApiHandler` | UserServiceをラップし、`ApiResponse<T>`形式でレスポンスを返す |

## 開発コマンド

```bash
npm run build   # TypeScriptをdist/にコンパイル
npm run test    # テスト実行
```
